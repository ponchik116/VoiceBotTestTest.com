<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Голос → BUZZ-перевод</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:20px}
    button{padding:8px 12px;margin:6px}
    #log{white-space:pre-wrap;border:1px solid #ddd;padding:10px;min-height:120px}
    label{margin-left:12px}
    .buzz-text {color: #ff6b00; font-weight: bold;}
  </style>
</head>
<body>
  <h2>Говорите (RU) — переводит в BUZZ-язык</h2>

  <div>
    <button id="startBtn">Начать</button>
    <button id="stopBtn" disabled>Остановить</button>
    <label>
      TTS-голос (BUZZ):
      <select id="voiceSelect"></select>
    </label>
  </div>

  <div id="status">Статус: ожидаю</div>
  <div id="log" aria-live="polite"></div>

<script>
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const status = document.getElementById('status');
const log = document.getElementById('log');
const voiceSelect = document.getElementById('voiceSelect');

const STOP_WORD = 'чеснок';
let recognition, voices = [], selectedVoiceName = null;
let stopRequested = false;

// SpeechRecognition init
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if (!SpeechRecognition) {
  status.textContent = 'SpeechRecognition не поддерживается в этом браузере.';
  startBtn.disabled = true;
} else {
  recognition = new SpeechRecognition();
  recognition.lang = 'ru-RU';
  recognition.interimResults = false;
  recognition.continuous = false;
}

// Load voices
function loadVoices() {
  voices = speechSynthesis.getVoices() || [];
  voiceSelect.innerHTML = '';
  voices.forEach(v => {
    const opt = document.createElement('option');
    opt.value = v.name;
    opt.textContent = `${v.name} (${v.lang})${v.default ? ' — default' : ''}`;
    voiceSelect.appendChild(opt);
  });
  if (!selectedVoiceName && voices.length) {
    selectedVoiceName = voices[0].name;
  }
  if (selectedVoiceName) voiceSelect.value = selectedVoiceName;
}
loadVoices();
speechSynthesis.onvoiceschanged = loadVoices;
voiceSelect.addEventListener('change', ()=> selectedVoiceName = voiceSelect.value);

// BUZZ-переводчик
function translateToBuzz(text) {
  const words = text.toLowerCase().split(/\s+/);
  const buzzWords = words.map(word => {
    if (word.length === 0) return '';
    
    const length = word.length;
    
    // Разные варианты BUZZ в зависимости от длины слова
    if (length <= 2) return 'bz';
    if (length === 3) return 'bzz';
    if (length === 4) return 'Bzzh';
    if (length === 5) return 'Buzz';
    if (length === 6) return 'BUZZ';
    if (length === 7) return 'buzzz';
    if (length === 8) return 'BzzzzZZz';
    if (length === 9) return 'Buzzuh';
    if (length >= 10) return 'BUZZ'.repeat(Math.ceil(length/4)).slice(0, length);
    
    return 'buzz';
  });
  
  return buzzWords.join(' ');
}

// Simple logger
function logMsg(s, isBuzz = false) {
  const prefix = isBuzz ? '<span class="buzz-text">BUZZ: </span>' : 'RU: ';
  log.innerHTML = `${new Date().toLocaleTimeString()} — ${prefix}${s}\n` + log.innerHTML;
}

// Speak with selected voice
function speakText(text) {
  if (!text) return Promise.resolve();
  return new Promise(resolve => {
    const utter = new SpeechSynthesisUtterance(text);
    const currentVoices = speechSynthesis.getVoices() || [];
    let v = currentVoices.find(x => x.name === selectedVoiceName);
    if (!v) {
      v = currentVoices[0];
      if (v) selectedVoiceName = v.name;
      if (voiceSelect) voiceSelect.value = selectedVoiceName;
    }
    if (v) utter.voice = v;
    utter.rate = 0.8; // Медленнее для BUZZ-эффекта
    utter.pitch = 1.2; // Выше тоном
    utter.onend = () => resolve();
    utter.onerror = () => resolve();
    speechSynthesis.speak(utter);
  });
}

// Recognition handlers
if (recognition) {
  recognition.onstart = () => {
    status.textContent = 'Слушаю...';
    startBtn.disabled = true;
    stopBtn.disabled = false;
  };
  recognition.onerror = (e) => {
    console.warn('rec error', e);
    if (!stopRequested) setTimeout(()=>{ try{ recognition.start(); }catch{} }, 250);
  };
  recognition.onend = () => {
    if (stopRequested) {
      status.textContent = 'Остановлено';
      startBtn.disabled = false;
      stopBtn.disabled = true;
      return;
    }
    try { recognition.start(); } catch(e) {}
  };
  recognition.onresult = async (evt) => {
    const text = (evt.results[0][0].transcript || '').trim();
    if (!text) return;
    logMsg(text);
    
    if (text.toLowerCase().split(/\s+/).includes(STOP_WORD)) {
      logMsg('Стоп-слово: остановка');
      stopRequested = true;
      try { recognition.stop(); } catch(e){}
      speechSynthesis.cancel();
      status.textContent = 'Остановлено (услышано стоп-слово)';
      startBtn.disabled = false;
      stopBtn.disabled = true;
      return;
    }

    // Переводим в BUZZ и озвучиваем
    status.textContent = 'Перевожу в BUZZ...';
    const buzzText = translateToBuzz(text);
    logMsg(buzzText, true);
    status.textContent = 'Говорю BUZZ...';
    await speakText(buzzText);
    status.textContent = 'Слушаю...';
  };
}

// Buttons
startBtn.addEventListener('click', async () => {
  if (!recognition) return;
  stopRequested = false;
  log.innerHTML = '';
  status.textContent = 'Загрузка голосов...';
  
  await new Promise(res => {
    loadVoices();
    if (speechSynthesis.getVoices().length) return res();
    speechSynthesis.addEventListener('voiceschanged', function fc(){ loadVoices(); speechSynthesis.removeEventListener('voiceschanged', fc); res(); });
    setTimeout(res, 1500);
  });
  status.textContent = 'Слушаю...';
  try { recognition.start(); } catch(e) {}
});

stopBtn.addEventListener('click', () => {
  stopRequested = true;
  try { recognition.stop(); } catch(e) {}
  speechSynthesis.cancel();
  status.textContent = 'Остановлено вручную';
  startBtn.disabled = false;
  stopBtn.disabled = true;
});
</script>
</body>
</html>
